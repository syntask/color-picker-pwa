<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no,width=device-width,viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/nano.min.css" />
<link rel="apple-touch-icon" href="icon-180.png">
<title>Color</title>
<style>
:root {
    --default-color: #aaaaaa;
    --padding-left: max(env(safe-area-inset-left),16px);
    --padding-right: max(env(safe-area-inset-right),16px);
    --padding-top: env(safe-area-inset-top);
    --padding-bottom: env(safe-area-inset-bottom);
}
html{
	padding: 0;
    margin: 0;
}

body {
    height:100vh;
    width: 100vw;
	margin: 0;
    padding: 0px;
    touch-action: none;
}

.color {
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    color: #fff;
    padding-left: var(--padding-left);
    padding-right: var(--padding-right);
    padding-top: 16px;
    padding-bottom: 16px;
    font-family: monospace;
    font-size: 2em;
    font-weight: bold;
    line-height: 1;
    flex-grow: 1;
    transition: flex-grow .5s, padding-top .5s, padding-bottom .25s, line-height .125s;
    text-align: left;
}

#content-area{
	display: flex;
    flex-direction: column;
    height: 100dvh;
}

#color-list{
	display: flex;
    flex-direction: column;
    justify-content: flex-end;
    flex-grow: 1;
}

#top-margin{
    height: var(--padding-top);
}

#bottom-margin{
    height: var(--padding-bottom);
}

#add-color-button{
    position: fixed;
    bottom: max(16px, env(safe-area-inset-bottom));
    right: max(16px, env(safe-area-inset-right));
    height: 50px;
    background-color: white;
    color: black;
    font-size: 1.5em;
    font-weight: bold;
    border: none;
    cursor: pointer;
    padding: 0 16px;
    border-radius: 999px;
}

.pickr {
    display: none;
}

.pcr-app {
    top: max(env(safe-area-inset-top), 16px) !important;
    width: 100% !important;
    max-width: none !important;
    background-color: white !important;
}

.pcr-selection {
    display: flex !important;
    flex-direction: column !important;
}

.pcr-color-preview {
    display: none !important;
}

.pcr-color-chooser {
    width: 100% !important;
}

.pcr-color-opacity {
    width: 100% !important;
}
</style>
</head>
<body>
<div id="content-area">
    <div id="top-margin"></div>
    <div id="color-list">

    </div>
    <div id="bottom-margin"></div>
    <button id="add-color-button">Add color</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr"></script>
<script>
const root = document.documentElement; 
let colors
let lastColor
const addColorButton = document.getElementById('add-color-button');

addColor();

function updateColors() {
    colors = document.querySelectorAll('.color');
    firstColor = colors[0];
    lastColor = colors[colors.length - 1];
    document.getElementById('top-margin').style.backgroundColor = firstColor.querySelector('.color-label').textContent;
    document.getElementById('bottom-margin').style.backgroundColor = lastColor.querySelector('.color-label').textContent;
}

updateColors();

function initializeColor(color){
    colorLabel = color.querySelector('.color-label');

    // Create a div inside the color div to hold the color picker but first ensure it doesn't already exist
    if (!color.querySelector('.pickr')) {
        const pickerElement = document.createElement('div');
        color.appendChild(pickerElement);
        const pickr = Pickr.create({
            el: pickerElement,
            theme: 'nano', // or 'classic', 'monolith', 'nano'
            default: colorLabel.textContent,
            components: {
                // Main components
                preview: true,
                opacity: true,
                hue: true,

                // Input / output Options
                interaction: {
                    hex: true,
                    rgba: true,
                    hsla: true,
                    hsva: true,
                    cmyk: true,
                    input: true,
                    save: true
                }
            }
        });
        pickr.on('change', (colorIndex, instance) => {
            color.querySelector('.color-label').textContent = colorIndex.toHEXA().toString();
            color.style.setProperty('background-color', color.textContent);
            color.style.setProperty('color', safeColor(color.textContent));
            pickr.applyColor(true);
            updateColors();
        });
    }

    color.style.setProperty('background-color', colorLabel.textContent);
    color.style.setProperty('color', safeColor(colorLabel.textContent));
    color.querySelector('.color-label').addEventListener('click', (event) => {
        // Simulate a click on the color picker
        color.querySelector('.pcr-button').click();
    });
}

function safeColor(color) {
    const r = parseInt(color.substr(1, 2), 16);
    const g = parseInt(color.substr(3, 2), 16);
    const b = parseInt(color.substr(5, 2), 16);
    const brightness = Math.sqrt(0.299 * r * r + 0.587 * g * g + 0.114 * b * b);
    if (brightness < 150) {
        return '#ffffff';
    } else {
        return '#000000';
    }
}

function generateRandomColor() {
    let color = '#';
    const characters = '0123456789ABCDEF';
    for (let i = 0; i < 6; i++) {
        color += characters[Math.floor(Math.random() * 16)];
    }
    return color;
}

function addColor() {
    const newColor = document.createElement('div');
    const newColorLabel = document.createElement('div');
    newColor.classList.add('color');
    newColorLabel.classList.add('color-label');
    newColorLabel.textContent = generateRandomColor();
    document.getElementById('color-list').appendChild(newColor);
    newColor.appendChild(newColorLabel);
    initializeColor(newColor);
    newColor.style.setProperty('flex-grow', '0');
    newColor.style.setProperty('overflow', 'hidden');
    newColor.style.setProperty('padding-top', '0');
    newColor.style.setProperty('padding-bottom', '0');
    newColor.style.setProperty('line-height', '0');
    setTimeout(() => {
        newColor.style.setProperty('line-height', '');
        newColor.style.setProperty('padding-top', '');
        newColor.style.setProperty('padding-bottom', '');
        newColor.style.setProperty('flex-grow', '');
    }, 0);
}

addColorButton.addEventListener('click', (event) => {
    addColor();
    updateColors();
});

//reset #content-area height on orientation change
window.addEventListener('orientationchange', () => {
    document.getElementById('content-area').style.height = '100dvh';
});
window.addEventListener('resize', () => {
    document.getElementById('content-area').style.height = '100dvh';
});
</script>
</body>
</html>
